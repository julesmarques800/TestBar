<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Devis - EQUINOX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #2c3e50;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 24px 60px 26px;
            border-bottom: 4px solid #e74c3c;
            text-align: left;
        }
        
        header h1 {
            font-size: 2em;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        
        header p {
            color: #ecf0f1;
            font-size: 0.9em;
            line-height: 1.5;
            max-width: 800px;
        }
        
        .brand-line {
            font-size: 0.9em;
            margin-bottom: 4px;
            opacity: 0.9;
        }
        
        .brand-line span {
            font-weight: 600;
        }
        
        .container {
            max-width: 1300px;
            margin: 25px auto 40px;
            background: white;
            padding: 30px 40px 40px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.04);
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 300;
            color: #2c3e50;
            margin-bottom: 18px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e74c3c;
        }
        
        form {
            width: 100%;
        }
        
        .form-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px 24px;
            margin-bottom: 25px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            flex: 1 1 260px;
        }
        
        label {
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        input {
            padding: 9px 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.95em;
            font-family: inherit;
        }
        
        .devis-info {
            margin-bottom: 20px;
            font-size: 0.95em;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: space-between;
            align-items: center;
        }
        
        .devis-info span.label {
            font-weight: 600;
        }
        
        .devis-number {
            font-size: 1.1em;
            font-weight: 600;
            color: #e74c3c;
        }
        
        #statsContainer {
            margin: 0 0 18px 0;
            padding: 10px;
            font-size: 0.95em;
            background: #ffffff;
            border: 1px solid #ddd;
            line-height: 1.5;
        }
        
        #statsContainer strong {
            font-weight: 600;
        }
        
        .order-summary {
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-top: 15px;
            font-size: 0.9em;
        }
        
        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        
        th {
            background-color: #27ae60;
            color: white;
            font-weight: 500;
        }
        
        .svg-container-td {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            padding: 0;
        }
        
        .svg-container-td img {
            width: 100%;
            max-height: 20px;
            object-fit: contain;
            display: block;
        }
        
        .color-box {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .color-item {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 2px 4px;
        }
        
        .color-sample {
            width: 18px;
            height: 18px;
            border: 1px solid #000;
            display: inline-block;
        }
        
        .color-ref {
            font-size: 0.8em;
            color: #333;
            font-weight: 600;
        }
        
        .actions {
            margin-top: 20px;
            text-align: center;
        }
        
        .btn {
            padding: 10px 26px;
            font-size: 0.9em;
            background-color: #27ae60;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn:hover:enabled {
            background-color: #229954;
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: default;
        }
        
        #loading {
            display: none;
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 8px;
        }
        
        footer {
            text-align: center;
            padding: 12px 20px 18px;
            color: #7f8c8d;
            font-size: 0.85em;
        }
        
        @media (max-width: 768px) {
            header {
                padding: 18px 20px 20px;
            }
            .container {
                padding: 20px 16px 28px;
                margin: 15px auto 30px;
            }
            th,
            td {
                font-size: 0.8em;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand-line">
            <span>EQUINOX</span> ‚Äì Cr√©ateur d'espaces √©questres
        </div>
        <h1>Devis</h1>
        <p>
            Renseignez le nom, le pr√©nom et la date de livraison souhait√©e. T√©l√©chargez ensuite votre devis en PDF. Le num√©ro de devis s'incr√©mente automatiquement √† chaque g√©n√©ration.
        </p>
    </header>

    <main class="container">
        <div id="pdfContent">
            <div class="devis-info">
                <div>
                    <span class="label">Num√©ro de devis :</span>
                    <span class="devis-number">DV-<span id="devisNumber">0001</span></span>
                </div>
                <div id="devisDateDisplay"></div>
            </div>

            <form id="devisForm" onsubmit="return false;">
                <div class="section-title">Informations client</div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="lastName">Nom *</label>
                        <input type="text" id="lastName" name="lastName" required>
                    </div>

                    <div class="form-group">
                        <label for="firstName">Pr√©nom *</label>
                        <input type="text" id="firstName" name="firstName" required>
                    </div>

                    <div class="form-group">
                        <label for="deliveryDate">Date de livraison souhait√©e *</label>
                        <input type="date" id="deliveryDate" name="deliveryDate" required>
                    </div>
                </div>

                <div id="statsContainer">
                    <strong>üìä Statistiques :</strong><br>
                    <span id="count3m">0</span> barres de <strong>3 m</strong><br>
                    <span id="count35m">0</span> barres de <strong>3,5 m</strong><br> Total : <strong><span id="countTotal">0</span> barres</strong>
                </div>

                <div class="order-summary">
                    <div class="section-title">Votre s√©lection</div>

                    <table>
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Mod√®le</th>
                                <th>Couleurs</th>
                                <th>Longueur</th>
                                <th>Hauteur</th>
                                <th>Diam√®tre</th>
                                <th>Quantit√©</th>
                            </tr>
                        </thead>
                        <tbody id="orderTable"></tbody>
                    </table>
                </div>
            </form>
        </div>

        <div class="actions">
            <button type="button" class="btn" id="downloadBtn" onclick="generatePdf()">T√©l√©charger le devis en PDF</button>
            <p id="loading">G√©n√©ration du PDF...</p>
        </div>
    </main>

    <footer>
        ¬© 2025 EQUINOX - Cr√©ateur d'espaces √©questres
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

    <script>
        const hexToRal = {
            "#d0b084": "RAL 1001",
            "#ddc49a": "RAL 1014",
            "#e6d2b5": "RAL 1015",
            "#f1dd38": "RAL 1016",
            "#da6e00": "RAL 2000",
            "#c73f4a": "RAL 3018",
            "#bb1e10": "RAL 3020",
            "#8d3c4b": "RAL 4002",
            "#193153": "RAL 5013",
            "#637d96": "RAL 5014",
            "#222d5a": "RAL 5022",
            "#114232": "RAL 6005",
            "#61993b": "RAL 6018",
            "#b9ceac": "RAL 6019",
            "#8a9977": "RAL 6021",
            "#575d5e": "RAL 7012",
            "#4f5358": "RAL 7015",
            "#383e42": "RAL 7016",
            "#2f3234": "RAL 7021",
            "#4c4a44": "RAL 7022",
            "#c5c7c4": "RAL 7035",
            "#7a7b7a": "RAL 7037",
            "#8e9291": "RAL 7042",
            "#8d9295": "RAL 7045",
            "#66332b": "RAL 8012",
            "#4a3526": "RAL 8014",
            "#e9e0d2": "RAL 9001",
            "#2b2b2c": "RAL 9004",
            "#0e0e10": "RAL 9005",
            "#f1ece1": "RAL 9010",
            "#f1f0ea": "RAL 9016"
        };

        let currentDevisNumber = 1;

        function loadDevisNumber() {
            const stored = localStorage.getItem("devisCounter");
            currentDevisNumber = stored ? parseInt(stored, 10) : 1;
            if (isNaN(currentDevisNumber) || currentDevisNumber < 1) currentDevisNumber = 1;
            updateDevisNumberDisplay();
        }

        function formatDevisNumber(num) {
            return num.toString().padStart(4, "0");
        }

        function updateDevisNumberDisplay() {
            const span = document.getElementById("devisNumber");
            if (span) span.textContent = formatDevisNumber(currentDevisNumber);
        }

        function incrementDevisNumber() {
            currentDevisNumber += 1;
            localStorage.setItem("devisCounter", currentDevisNumber);
            updateDevisNumberDisplay();
        }

        function updateDevisDate() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            };
            const frDate = now.toLocaleDateString('fr-FR', options);
            const el = document.getElementById("devisDateDisplay");
            if (el) el.textContent = "Date du devis : " + frDate;
        }

        function makeColorsHtml(colors, customRal) {
            if (!colors) return "";
            return colors.map(c => {
                const hex = String(c).toLowerCase();
                const ralCode = hexToRal[hex] || (customRal || "RAL inconnu");
                return `
                    <div class="color-item">
                        <span class="color-sample" style="background-color:${c};"></span>
                        <span class="color-ref">${ralCode}</span>
                    </div>
                `;
            }).join("");
        }

        function updateStats(cart) {
            let count3m = 0;
            let count35m = 0;

            cart.forEach(item => {
                const qty = item.quantity || 1;
                if (item.length === "3m") count3m += qty;
                if (item.length === "3.5m") count35m += qty;
            });

            const total = count3m + count35m;

            document.getElementById("count3m").textContent = count3m;
            document.getElementById("count35m").textContent = count35m;
            document.getElementById("countTotal").textContent = total;
        }

        function svgToImgHtml(svgString, altText) {
            if (!svgString) return "‚ùå Erreur SVG";
            const encoded = encodeURIComponent(svgString);
            return `<img src="data:image/svg+xml;utf8,${encoded}" alt="${altText}">`;
        }

        function loadOrderSummary() {
            console.log("üì¶ Chargement du r√©sum√© de commande...");
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            const orderTable = document.getElementById("orderTable");

            orderTable.innerHTML = "";
            updateStats(cart);

            if (cart.length === 0) {
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="7">Aucun article dans le panier.</td>`;
                orderTable.appendChild(row);
                console.log("‚ÑπÔ∏è Panier vide pour le devis.");
                return;
            }

            cart.forEach(item => {
                const imgHtml = svgToImgHtml(item.svg, `Mod√®le ${item.model}`);
                const colorsHtml = makeColorsHtml(item.colors, item.custom_ral || null);
                const heightDisplay = item.height || "-";
                const diameterDisplay = item.diameter || "-";

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td class="svg-container-td">${imgHtml}</td>
                    <td>Mod√®le ${item.model}</td>
                    <td><div class="color-box">${colorsHtml}</div></td>
                    <td>${item.length || "Non sp√©cifi√©"}</td>
                    <td>${heightDisplay}</td>
                    <td>${diameterDisplay}</td>
                    <td>${item.quantity}</td>
                `;
                orderTable.appendChild(row);
            });

            console.log("‚úÖ R√©sum√© du devis charg√© avec succ√®s !");
        }

        async function generatePdf() {
            const lastName = document.getElementById("lastName").value.trim();
            const firstName = document.getElementById("firstName").value.trim();
            const deliveryDate = document.getElementById("deliveryDate").value.trim();
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const downloadBtn = document.getElementById("downloadBtn");
            const loadingText = document.getElementById("loading");

            if (!lastName || !firstName || !deliveryDate) {
                alert("Veuillez remplir tous les champs obligatoires (nom, pr√©nom, date de livraison).");
                return;
            }

            if (!cart || cart.length === 0) {
                alert("Votre panier est vide, impossible de g√©n√©rer un devis.");
                return;
            }

            const currentNumberFormatted = formatDevisNumber(currentDevisNumber);
            const fileName = `Devis_EQX_${currentNumberFormatted}.pdf`;

            downloadBtn.disabled = true;
            loadingText.style.display = "block";

            const infoBloc = document.getElementById("devisDateDisplay");
            if (infoBloc) {
                const now = new Date();
                const frNow = now.toLocaleDateString('fr-FR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
                infoBloc.textContent = `Date du devis : ${frNow} ‚Äì Client : ${firstName} ${lastName} ‚Äì Livraison souhait√©e : ${deliveryDate}`;
            }

            const element = document.getElementById('pdfContent');
            const opt = {
                margin: 10,
                filename: fileName,
                image: {
                    type: 'jpeg',
                    quality: 0.98
                },
                html2canvas: {
                    scale: 1
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait'
                }
            };

            try {
                await html2pdf().set(opt).from(element).save();
                incrementDevisNumber();
            } catch (err) {
                console.error("Erreur lors de la g√©n√©ration du PDF :", err);
                alert("Une erreur est survenue pendant la g√©n√©ration du PDF.");
            } finally {
                downloadBtn.disabled = false;
                loadingText.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadDevisNumber();
            updateDevisDate();
            loadOrderSummary();
        });
    </script>
</body>

</html>